---
title: "PreguntaCristianAntonio"
author: "Cristian Antonio Cabello Arango"
date: "2024-03-06"
output:
  html_document: default
  pdf_document: default
---

### ¿Cómo se relacionan los Factores Demográficos con la Salud Mental?

# **Carga de datos**

En esta sección, se cargan los conjuntos de datos datosMH1, datosMH2, datosMH3, y datosMH4 desde archivos CSV ubicados en la carpeta "data".

```{r}
dataMH1 <- read.csv("data/datosMH1.csv")
dataMH2 <- read.csv("data/datosMH2.csv")
dataMH3 <- read.csv("data/datosMH3.csv")
dataMH4 <- read.csv("data/datosMH4.csv")

head(datosMH1)
head(datosMH2)
head(datosMH3)
head(datosMH4)
```

# Preprocesamiento

En este apartado se comienza con la etapa de preprocesameinto de los datos con una fusión de los conjuntos de datos, obtenidos de las preguntas planteadas para el proyecto grupal, por pares (datosMH1 y datosMH4, datosMH2 y datosMH3) en función de las columnas "Entity" y "Year". Luego, se fusionan los resultados de estas dos fusiones en un único conjunto de datos df.

```{r}
df1 <- merge(datosMH1, datosMH4, by = c("Entity", "Year"))
df1 <- df1[3137: nrow(df1), ]
rownames(df1) <- NULL

df2 <- merge(datosMH2, datosMH3, by = c("Entity", "Year"))
df2 <- df2[3137: nrow(df2), ]
rownames(df2) <- NULL

df <- merge(df1, df2, by = c("Entity", "Year"))

print(df)
```

```{r}
df <- subset(df, select = -Code.x.x)
df <- subset(df, select = -Code.y.x)
df <- subset(df, select = -Code.x.y)
df <- subset(df, select = -Code.y.y)
df <- subset(df, select = -Population.y)

df$Schizophrenia <- as.double(df$Schizophrenia)
df$Bipolar.disorders <- as.double(df$Bipolar.disorders)
df$Eating.disorders <- as.double(df$Eating.disorders)
df$`Prevalence - Depressive disorders - Sex: Both - Age: All Ages (Number) (people suffering from depression)` <- as.double(df$`Prevalence - Depressive disorders - Sex: Both - Age: All Ages (Number) (people suffering from depression)`)
df$`Prevalence in males (%)` <- as.double(df$`Prevalence in males (%)`)
df$`Prevalence in females (%)` <- as.double(df$`Prevalence in females (%)`)
df$`Suicide rate (deaths per 100000 individuals)`<-as.double(df$`Suicide rate (deaths per 100000 individuals)`)
df$`Depressive disorder rates (number suffering per 100000)`<- as.double(df$`Depressive disorder rates (number suffering per 100000)`)
df$Year <- as.integer(df$Year)
df$Population.x <- as.integer(df$Population.x)

na_val <- colSums(is.na(df))
print("Valores nulos en df:")
print(na_val)




```

En esta etapa se han eliminado columnas innecesarias del conjunto de datos df utilizando la función subset(). Además, se convierten ciertas columnas a tipos de datos numéricos o enteros usando as.double() y as.integer() para mantener una coherencia en la aplicación de las técnicas que se verán mas adelante.

Cabe destacar que ninguna de las variables del conjunto muestra valores nulos salvo la variable "Population.x". Analizando el conjunto de datos hemos observado que las filas con datos faltantes en esta variable se produce debido a que hay zonas continentales que se definen como entidades al igual que los países y no tienen en cuenta el número de habitantes pues se podrían obtener agrupando los países que forman parte de dicha zona continental. Por ello, se decide dividir dos datasets, uno que contengan los datos por zonas continentales (con los valores nulos de la población) y otro dataset con los datos por cada país (sin valores nulos).

```{r}
df_w <- df[is.na(df$Population.x), ]
df_p <- df[!is.na(df$Population.x), ]

head(df_w)
head(df_p)

```

En df_w se encuentran los datos de los continentes, por eso contiene valores nulos en la población. En df_p se encuentran los datos de los países del mundo y no contiene valores nulos en ninguno de sus atributos.

```{r}
summary(df_p)

```

# Visualización de datos

En este apartado, se pretende representar diferentes gráficas que repreesentan información sobre las tasas de suicidios.

En primer lugar, se representa la prevalencia de trastornos mentales en hombres y mujeres a lo largo de los años en el mundo, así como la prevalencia de diferentes trastornos mentales por año. Estos gráficos permitirán comprender de forma visual de cómo han variado estas prevalencias con el tiempo.

```{r}
library(ggplot2)
library(dplyr)

max_values <- df_p %>%
  group_by(Year) %>%
  summarise(max_male = max(`Prevalence in males (%)`, na.rm = TRUE),
            max_female = max(`Prevalence in females (%)`, na.rm = TRUE))

hist <- ggplot(df_p, aes(x = Year)) +
          geom_col(aes(y = `Prevalence in males (%)`, fill = "Prevalencia en hombres"), position = position_nudge(x = -0.2), width = 0.4, color = "blue") +
          geom_col(aes(y = `Prevalence in females (%)`, fill = "Prevalencia en mujeres"), position = position_nudge(x = 0.2), width = 0.4, color = "red") +
          labs(title = "Prevalencia en Hombres y Mujeres por Año en el Mundo",
               x = "Año",
               y = "Prevalencia") +
          scale_fill_manual(values = c("Prevalencia en hombres" = "blue", "Prevalencia en mujeres" = "red")) +
          geom_point(data = max_values, aes(y = max_male), color = "black") +
          geom_point(data = max_values, aes(y = max_female), color = "black") +
          geom_line(data = max_values, aes(y = max_male), color = "black") +
          geom_line(data = max_values, aes(y = max_female), color = "black") +
          theme_minimal()

# Mostrar el histograma
print(hist)


```

Como se puede observar, tanto la tendencia de prevalencia en hombre como la prevalencia en mujeres de trastornos en salud mental parece constante a lo largo del rango de los años entre el 1990 y el 2017. Además, se aprecia claramente que la prevalencia es mayor en mujeres que en hombres en prácticamente el doble de porcentaje.

En segundo lugar se representa un gráfico de barras que muestra el porcentaje de enfermedades mentales en el mundo a lo largo de los años.

```{r}
max_values_mental_disorders <- df_p %>%
  group_by(Year) %>%
  summarise(max_mental_disorder = max(Schizophrenia, Bipolar.disorders, Eating.disorders, Anxiety.disorders, Drug.use.disorders, Depression, Alcohol.use.disorders, na.rm = TRUE))

options(repr.plot.width = 20, repr.plot.height = 6)

hist_mental_disorders <- ggplot(df_p, aes(x = Year)) +
  geom_col(aes(y = Schizophrenia, fill = "Esquizofrenia"), position = position_nudge(x = -0.5), width = 0.1, color = "blue") +
  geom_col(aes(y = Bipolar.disorders, fill = "Trastorno bipolar"), position = position_nudge(x = -0.3), width = 0.1, color = "green") +
  geom_col(aes(y = Eating.disorders, fill = "Trastornos de la alimentación"), position = position_nudge(x = -0.1), width = 0.1, color = "red") +
  geom_col(aes(y = Anxiety.disorders, fill = "Trastornos de ansiedad"), position = position_nudge(x = 0.1), width = 0.1, color = "orange") +
  geom_col(aes(y = Drug.use.disorders, fill = "Trastornos por consumo de drogas"), position = position_nudge(x = 0.3), width = 0.1, color = "purple") +
  geom_col(aes(y = Depression, fill = "Depresión"), position = position_nudge(x = 0.5), width = 0.1, color = "yellow") +
  geom_col(aes(y = Alcohol.use.disorders, fill = "Trastornos por consumo de alcohol"), position = position_nudge(x = 0.7), width = 0.1, color = "pink") +
  labs(title = "Enfermedades mentales con mayor prevalencia por año en el mundo",
       x = "Año",
       y = "Prevalencia") +
  scale_fill_manual(values = c("Esquizofrenia" = "blue", "Trastorno bipolar" = "green", "Trastornos de la alimentación" = "red", "Trastornos de ansiedad" = "orange", "Trastornos por consumo de drogas" = "purple", "Depresión" = "yellow", "Trastornos por consumo de alcohol" = "pink")) 
print(hist_mental_disorders)

```

Como podemos observar, los trastornos de ansiedad superan en creces el resto de trastornos, seguido de los trastornos por depresión. El resto de trastornos oscila en valores por debajo del 3%. La gran mayoría presentan una tendencia constante. menos los trastornos por consumo de drogas que presentan una tendencia creciente.

# Reglas de asociación

En este apartado hemos utilizado la técnica de reglas de asociación para un análisis de patrones o asociaciones interesantes entre las variables del conjunto de datos.

```{r}
if(!require(arules)) install.packages("arules")
library(arules)
```

```{r}
reglas <- apriori(df_p) 
inspect(reglas)
```

Vemos que hemos obtenido 935 reglas, lo que significa una gran cantidad y un alto tiempo de procesamiento y obtención de resultados. Por ello, decidimos acotar las variables en las que pretendemos obtener las reglas de asociación entre los diferentes trastornos de enfermedad mental y los países mundiales.

Para observar las reglas de asociación entre la prevalencia en trastornos mentales por género para cada país en el conjunto de datos, hemos seleccionado las siguientes variables:

Con estas variables, se intentará identificar asociaciones entre los trastornos mentales para cada país utilizando el algoritmo Apriori.

```{r}
paises <- dataset_paises$Entity
vector_entity_pais <- paste("Entity=", paises, sep="")
print(vector_entity_pais)
```

```{r}
dataset <- df_p[, c("Entity", "Schizophrenia", "Bipolar.disorders", "Eating.disorders", "Anxiety.disorders", "Drug.use.disorders", "Depression", "Alcohol.use.disorders")]
head(dataset)

rules <- apriori(dataset, parameter = list(minval=2, support = 0.005),
                 appearance = list(rhs=c(vector_entity_pais), default="lhs"))

inspect(rules)

```

En esta ejecución se han obtenido 351 resultados de regals de asociación. Para poder entender un poco más las soluciones, representamos las 10 reglas ordenadas por la confianza.

```{r}
top_10_item <- sort(rules, by="confidence", decreasing=TRUE) [1:10]

inspect(top_10_item)
```

Como podemos observar,el consecuente Greenland presenta la confianza más alta. También se observan varios consecuentes repetidos en estas reglas en países como Haiti, Chipre o Israel. Por ejemplo, para el último resultado podemos observar que en Haiti, los porcentajes de enfermedades mentales como la esquizofrenia ronda entre el rango semicerrado de 0.147% y 0.189%, trastornos por bipolaridad en un rango semicerrado de 0.781% y 1.21% y depresión entre 2.14% y 3.14%.

# Visualización de resultados

Para finalizar el proyecto, hemos representado una gráfica de barra de la confianza de las reglas de asociación por país.

```{r}
for (pais in vector_entity_pais) {
  rules_country <- subset(rules, subset = rhs %in% pais)
  if (length(rules_country) > 0) {
    rules_country <- sort(rules_country, by="confidence", decreasing=TRUE)[1]
    inspect(rules_country)
  }
}

```

```{r}
library(ggplot2)

df <- data.frame(Pais = character(),
                 Confianza = numeric(),
                 stringsAsFactors = FALSE)

for (pais in vector_entity_pais) {
  rules_country <- subset(rules, subset = rhs %in% pais)
  if (length(rules_country) > 0) {
    top_rule <- sort(rules_country, by="confidence", decreasing=TRUE)[1]
    df <- rbind(df, data.frame(Pais = pais, Confianza = top_rule@quality$confidence))
  }
}
ggplot(df, aes(x = reorder(Pais, -Confianza), y = Confianza)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Confianza de la regla más alta por país",
       x = "País",
       y = "Confianza") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Para obtener este resultado hemos seleccionado el valor de confianza máximo para cada país y hemos graficado el resultado. Como se puede observar, la mayor confianza de las reglas de asociación se presenta en países americanos como Argentica, Canada o Colombia.

En resumen, este proyecto realiza un análisis exhaustivo de datos relacionados con la salud mental a nivel mundial, utilizando técnicas de preprocesamiento, visualización y análisis de reglas de asociación para obtener información valiosa sobre la prevalencia de trastornos mentales y su relación con la ubicación geográfica, observando que los países americanos obtienen información con un mayor porcentaje de confianza que el resto. Por ello, podemos afirmar que para otros estudios, se podrían simplificar los datos agrupando por el continente americano.

Muchas gracias.
