---
title: "PreguntaCristianAntonio"
author: "ccabello"
date: "2024-03-03"
output: html_document
---

```{r}
dataMH1 <- read.csv("data/datosMH1.csv")
dataMH2 <- read.csv("data/datosMH2.csv")
dataMH3 <- read.csv("data/datosMH3.csv")
dataMH4 <- read.csv("data/datosMH4.csv")

head(datosMH1)
head(datosMH2)
head(datosMH3)
head(datosMH4)
```
```{r}
df1 <- merge(datosMH1, datosMH4, by = c("Entity", "Year"))
df1 <- df1[3137: nrow(df1), ]
rownames(df1) <- NULL

df2 <- merge(datosMH2, datosMH3, by = c("Entity", "Year"))
df2 <- df2[3137: nrow(df2), ]
rownames(df2) <- NULL

df <- merge(df1, df2, by = c("Entity", "Year"))

print(df)
```


```{r}
df <- subset(df, select = -Code.x.x)
df <- subset(df, select = -Code.y.x)
df <- subset(df, select = -Code.x.y)
df <- subset(df, select = -Code.y.y)
df <- subset(df, select = -Population.y)

df$Schizophrenia <- as.double(df$Schizophrenia)
df$Bipolar.disorders <- as.double(df$Bipolar.disorders)
df$Eating.disorders <- as.double(df$Eating.disorders)
df$`Prevalence - Depressive disorders - Sex: Both - Age: All Ages (Number) (people suffering from depression)` <- as.double(df$`Prevalence - Depressive disorders - Sex: Both - Age: All Ages (Number) (people suffering from depression)`)
df$`Prevalence in males (%)` <- as.double(df$`Prevalence in males (%)`)
df$`Prevalence in females (%)` <- as.double(df$`Prevalence in females (%)`)
df$`Suicide rate (deaths per 100000 individuals)`<-as.double(df$`Suicide rate (deaths per 100000 individuals)`)
df$`Depressive disorder rates (number suffering per 100000)`<- as.double(df$`Depressive disorder rates (number suffering per 100000)`)
df$Year <- as.integer(df$Year)
df$Population.x <- as.integer(df$Population.x)

na_val <- colSums(is.na(df))
print("Valores nulos en df:")
print(na_val)




```





```{r}
df_w <- df[is.na(df$Population.x), ]
df_p <- df[!is.na(df$Population.x), ]

head(df_w)
head(df_p)

```
En df_w se encuentran los datos de los continentes, por eso contiene valores nulos en la población.
En df_p se encuentran los datos de los países del mundo y no contiene valores nulos en ninguno de sus atributos.

```{r}
summary(df_p)
```


```{r}
library(ggplot2)
library(dplyr)

max_values <- df_p %>%
  group_by(Year) %>%
  summarise(max_male = max(`Prevalence in males (%)`, na.rm = TRUE),
            max_female = max(`Prevalence in females (%)`, na.rm = TRUE))

# Crear el histograma vertical
hist <- ggplot(df_p, aes(x = Year)) +
          geom_col(aes(y = `Prevalence in males (%)`, fill = "Prevalencia en hombres"), position = position_nudge(x = -0.2), width = 0.4, color = "blue") +
          geom_col(aes(y = `Prevalence in females (%)`, fill = "Prevalencia en mujeres"), position = position_nudge(x = 0.2), width = 0.4, color = "red") +
          labs(title = "Prevalencia en Hombres y Mujeres por Año en el Mundo",
               x = "Año",
               y = "Prevalencia") +
          scale_fill_manual(values = c("Prevalencia en hombres" = "blue", "Prevalencia en mujeres" = "red")) +
          geom_point(data = max_values, aes(y = max_male), color = "black") +
          geom_point(data = max_values, aes(y = max_female), color = "black") +
          geom_line(data = max_values, aes(y = max_male), color = "black") +
          geom_line(data = max_values, aes(y = max_female), color = "black") +
          theme_minimal()

# Mostrar el histograma
print(hist)
```

```{r}
if(!require(arules)) install.packages("arules")
library(arules)
```
```{r}
reglas <- apriori(df_p) 
inspect(reglas)
```



Vemos que hemos obtenido 935 reglas

Para observar las reglas de asociación entre la prevalencia en trastornos mentales por género para cada país en el conjunto de datos, hemos seleccionado las siguientes variables:

Entidad: Esta variable permitirá identificar cada país en el conjunto de datos y segmentar el análisis por país.


Prevalencia en hombres y mujeres: Incluye las variables que representan la prevalencia de trastornos mentales en hombres y mujeres por separado. Esto permitirá examinar las diferencias de género en la prevalencia de trastornos mentales para cada país.

Con estas variables, se intentará identificar asociaciones entre los trastornos mentales y los grupos de género para cada país utilizando técnicas de análisis de reglas de asociación, con el algoritmo Apriori.

```{r}
prevalence_data <- df_p[, c("Entity", "Prevalence in males (%)", "Prevalence in females (%)")]
head(prevalence_data)

paises <- unique(df_p$Entity)
dataset_paises <- data.frame(Entity = paises)
head(dataset_paises) 

prevalence_by_country <- aggregate(cbind(Prevalence_in_males, Prevalence_in_females) ~ Entity, data = prevalence_data, FUN = mean)
```

```{r}
paises <- dataset_paises$Entity

# Crear un vector que contenga la cadena "Entity=pais" para cada país
vector_entity_pais <- paste("Entity=", paises, sep="")

# Mostrar el vector resultante
print(vector_entity_pais)
```


```{r}
dataset <- df_p[, c("Entity", "Schizophrenia", "Bipolar.disorders", "Eating.disorders", "Anxiety.disorders", "Drug.use.disorders", "Depression", "Alcohol.use.disorders")]
head(dataset)

rules <- apriori(dataset, parameter = list(minval=2, support = 0.005),
                 appearance = list(rhs=c(vector_entity_pais), default="lhs"))

inspect(rules)

```


```{r}
top_10_item <- sort(rules, by="confidence", decreasing=TRUE) [1:10]

inspect(top_10_item)
```


```{r}
for (pais in vector_entity_pais) {
  rules_country <- subset(rules, subset = rhs %in% pais)
  if (length(rules_country) > 0) {
    rules_country <- sort(rules_country, by="confidence", decreasing=TRUE)[1]
    inspect(rules_country)
  }
}

```




```{r}
library(ggplot2)

df <- data.frame(Pais = character(),
                 Confianza = numeric(),
                 stringsAsFactors = FALSE)

for (pais in vector_entity_pais) {
  rules_country <- subset(rules, subset = rhs %in% pais)
  if (length(rules_country) > 0) {
    top_rule <- sort(rules_country, by="confidence", decreasing=TRUE)[1]
    df <- rbind(df, data.frame(Pais = pais, Confianza = top_rule@quality$confidence))
  }
}
ggplot(df, aes(x = reorder(Pais, -Confianza), y = Confianza)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Confianza de la regla más alta por país",
       x = "País",
       y = "Confianza") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotar las etiquetas del eje x para mayor legibilidad

```

























